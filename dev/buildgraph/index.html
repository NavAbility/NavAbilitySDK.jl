<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Build a Graph · NavAbilitySDK.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link rel="canonical" href="https://NavAbility.github.io/NavAbilitySDK.jl/buildgraph/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">NavAbilitySDK.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../start/">Getting Started</a></li><li><a class="tocitem" href="../variables/">Variables</a></li><li><a class="tocitem" href="../factors/">Factors</a></li><li class="is-active"><a class="tocitem" href>Build a Graph</a><ul class="internal"><li><a class="tocitem" href="#First-Pose"><span>First Pose</span></a></li><li><a class="tocitem" href="#Odometry-Factor"><span>Odometry Factor</span></a></li><li><a class="tocitem" href="#Adding-Different-Sensors"><span>Adding Different Sensors</span></a></li><li><a class="tocitem" href="#One-Loop-Closure-Example"><span>One Loop-Closure Example</span></a></li></ul></li><li><a class="tocitem" href="../solvers/">Graph Solvers</a></li><li><a class="tocitem" href="../summary/">Index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Build a Graph</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Build a Graph</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/NavAbility/NavAbilitySDK.jl/blob/main/docs/src/buildgraph.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Build-a-new-Factor-graph"><a class="docs-heading-anchor" href="#Build-a-new-Factor-graph">Build a new Factor graph</a><a id="Build-a-new-Factor-graph-1"></a><a class="docs-heading-anchor-permalink" href="#Build-a-new-Factor-graph" title="Permalink"></a></h1><p>The NavAbilitySDK provides variables and factors useful to robotics.  We start with a <code>Pose2</code> variable, i.e. position and orientation for a vehicle traveling on a flat XY plane.  </p><p>As before, let&#39;s setup a new client-context to talk with the NavAbility platform:</p><pre><code class="language-julia hljs"># also create a client connection
client = NavAbilityHttpsClient()

# create a client context user, robot, session
context = Client(
  &quot;guest@navability.io&quot;,
  &quot;ExampleRobot&quot;,
  &quot;SDKjl_&quot;*(string(uuid4())[1:4]),
)</code></pre><h2 id="First-Pose"><a class="docs-heading-anchor" href="#First-Pose">First Pose</a><a id="First-Pose-1"></a><a class="docs-heading-anchor-permalink" href="#First-Pose" title="Permalink"></a></h2><p>The <code>addVariable</code> function with a label <code>&quot;x0&quot;</code> and type <code>:Pose2</code> adds that variable to  to the factor graph.</p><pre><code class="language-julia hljs"># let&#39;s collect all the async responses and wait at the end
resultIds = Task[]
# addVariable and keep the transaction ID
push!(resultIds, 
  addVariable(client, context, &quot;x0&quot;, :Pose2)
);</code></pre><p>Note that asynchronous tasks are used to increase the upload performance.  Each of these events are queued on the server for processing.  While the variable is being created, let&#39;s also add a prior factor.</p><p>We now have a factor graph with one variable, but to solve it we need some additional information.  In this example, we need the estimated starting point of our robot. We use unary factors called priors to represent absolute information to be introduced.  In this case we use <code>PriorPose2</code>, as our variable type is also <code>Pose2</code>. Since factors represent a probabilistic interaction between variables, we need to specify the distribution our factor will represent. Here we use <code>FullNormal</code> which is a <a href="https://en.wikipedia.org/wiki/Multivariate_normal_distribution">multivariate normal distribution</a>. </p><p>Let&#39;s create a <code>PriorPose2</code> unary factor with zero mean and a covariance matrix of (<code>diagm([0.05,0.05,0.01].^2)</code>):</p><pre><code class="language-julia hljs">push!(
  resultIds, 
  addFactor(
    client, context, [&quot;x0&quot;], 
    NvaSDK.PriorPose2(;
      Z=FullNormal(
        [0.0, 0.0, 0.0], 
        diagm([0.05, 0.05, 0.01].^2)
      )
    )
  )
)</code></pre><p>After adding a batch of variables and factors, we can wait on the upload status to ensure the new graph elements have been processed:</p><pre><code class="language-julia hljs"># wait to make sure all nodes were added
waitForCompletion(client, resultIds; expectedStatuses=[&quot;Complete&quot;])</code></pre><p>As before, we can use the NavAbility App to visualize the factor graph</p><pre><code class="language-julia hljs"># Click on the generated URL or graphic to open the NavAbility App Graph visualization page for this session
GraphVizApp(context, variableStartsWith=&quot;&quot;)</code></pre><h2 id="Odometry-Factor"><a class="docs-heading-anchor" href="#Odometry-Factor">Odometry Factor</a><a id="Odometry-Factor-1"></a><a class="docs-heading-anchor-permalink" href="#Odometry-Factor" title="Permalink"></a></h2><p>An odometry factor connects two consecutive robot poses <code>x0</code> and <code>x1</code> together to form a chain.  Here we use a relative factor of type <code>Pose2Pose2</code> with a measurement from pose <code>x0</code> to <code>x1</code> of <code>(x=1.0,y=0.0,θ=pi/2)</code>; the robot drove 1 unit forward (in the x direction).  Similarly to the prior we added above, we use a <code>FullNormal</code> distribution to represent the odometry with mean and covariance:</p><pre><code class="language-julia hljs"># reset waiting list
resultIds = Task[]
# add x1
push!(resultIds, 
  addVariable(client, context, &quot;x1&quot;, :Pose2)
)

# add odometry measurement between x0 and x1
push!(
  resultIds, 
  addFactor(client, context, [&quot;x0&quot;,&quot;x1&quot;],
    NvaSDK.Pose2Pose2(;
      Z=FullNormal(
        [1.0, 0.0, pi/2], 
        diagm([0.1, 0.1, 0.01].^2)
      )
    )
  )
);</code></pre><h2 id="Adding-Different-Sensors"><a class="docs-heading-anchor" href="#Adding-Different-Sensors">Adding Different Sensors</a><a id="Adding-Different-Sensors-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-Different-Sensors" title="Permalink"></a></h2><p>So far we worked with the <code>Pose2</code> factor type.  Among others, <code>NavAbilitySDK</code> also provides the <code>Point2</code> variable and <code>Pose2Point2BearingRange</code> factor types, which we will use to represent a landmark sighting in our factor graph.  We will add a landmark <code>l1</code> with bearing range measurement of bearing=<code>(mu=0,sigma=0.03)</code> <code>range=(mu=0.5,sigma=0.1)</code> and continue our robot trajectory by driving around in a square.</p><pre><code class="language-julia hljs"># add one landmark
push!(resultIds,
  addVariable(client, context, &quot;l1&quot;, :Point2))

# add three more poses
for x in [&quot;x2&quot;; &quot;x3&quot;; &quot;x4&quot;]
  push!(resultIds,
    addVariable(client, context, x, :Pose2))
end

## add Factors

# add landmark observation measurement and
push!(resultIds, 
  addFactor(client, context, [&quot;x0&quot;,&quot;l1&quot;], 
    NvaSDK.Pose2Point2BearingRange(Normal(0, 0.03), Normal(0.5, 0.1))))    
  
# odometry measurements between poses
push!(resultIds, 
  addFactor(client, context, [&quot;x1&quot;,&quot;x2&quot;], 
    NvaSDK.Pose2Pose2(
      FullNormal(
       [1.0, 0.0, pi/2], 
       diagm([0.1, 0.1, 0.01].^2)))))

push!(resultIds, 
  addFactor(client, context, [&quot;x2&quot;,&quot;x3&quot;], 
    NvaSDK.Pose2Pose2(
      FullNormal(
       [1.0, 0.0, pi/2], 
       diagm([0.1, 0.1, 0.01].^2)))))

push!(resultIds, 
  addFactor(client, context, [&quot;x3&quot;,&quot;x4&quot;], 
    NvaSDK.Pose2Pose2(
      FullNormal(
        [1.0, 0.0, pi/2], 
        diagm([0.1, 0.1, 0.01].^2)))))

# let&#39;s wait to make sure all the new additions are ready
waitForCompletion(client, resultIds; expectedStatuses=[&quot;Complete&quot;])</code></pre><h2 id="One-Loop-Closure-Example"><a class="docs-heading-anchor" href="#One-Loop-Closure-Example">One Loop-Closure Example</a><a id="One-Loop-Closure-Example-1"></a><a class="docs-heading-anchor-permalink" href="#One-Loop-Closure-Example" title="Permalink"></a></h2><p>The robot continued its square trajectory to end off where it started.  To illustrate a loop closure, we add another bearing range sighting to from pose <code>x4</code> to landmark <code>l1</code>, solve the graph and plot the new results: </p><pre><code class="language-julia hljs">resultIds = Task[]
# add a loop closure landmark observation
push!(
  resultIds,
  addFactor(
    client, context, 
    [&quot;x4&quot;,&quot;l1&quot;], 
    NvaSDK.Pose2Point2BearingRange(
      Normal(0, 0.03), 
      Normal(0.5, 0.1))
  )
);

# let&#39;s wait to make sure all the new additions are ready
waitForCompletion(client, resultIds; expectedStatuses=[&quot;Complete&quot;])</code></pre><div class="admonition is-warning"><header class="admonition-header">Missing docstring.</header><div class="admonition-body"><p>Missing docstring for <code>waitForCompletion</code>. Check Documenter&#39;s build log for details.</p></div></div><div class="admonition is-warning"><header class="admonition-header">Missing docstring.</header><div class="admonition-body"><p>Missing docstring for <code>NvaSDK.waitForCompletion2</code>. Check Documenter&#39;s build log for details.</p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../factors/">« Factors</a><a class="docs-footer-nextpage" href="../solvers/">Graph Solvers »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Thursday 20 April 2023 05:12">Thursday 20 April 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
